---
title: "An exmple of numerical instability with Wilkinson's polynomial"
author: "JMA"
date: "September 1, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Wilkinson polynomial

Wilkinson polynomial has integer roots from 1 to $n$. Evaluate the polynomial by term by term construction
$w_n(x) = \prod_{k=1\ldots n}(x-k)$

This avoids integer rounding errors -  a smoother version

```{r wilkinson.products}

wilkinson.products <- function(x, nn=20) {
    w <- function(x, n=nn) {
        v <- rep(x, n) - seq(n)  # The terms in the polynomial product (x-1), (x-2), ...
        Reduce( '*', v)
    }
sapply(x, w)
}
```

Expanding the polynomial, one finds

```{r wilkinson.20}
wilkinson.20 <- function(x) {
    y <- x^20 - 210L * x^19 + 20615L * x^18 - 1256850L * x^17 + 53327946L * x^16 -
    1672280820L * x^15 +40171771630L * x^14 - 756111184500L * x^13 +
    11310276995381L * x^12 - 135585182899530L * x^11 +
    1307535010540395L * x^10 - 10142299865511450L * x^9 +
    63030812099294896L * x^8 - 311333643161390640L * x^7 +
    1206647803780373360L * x^6 - 3599979517947607200L * x^5 +
    8037811822645051776L * x^4 - 12870931245150988800L * x^3 +
    13803759753640704000L * x^2 - 8752948036761600000L * x +
    2432902008176640000L
    y
}
```
Note that just evaluating it in this form suffers from a few percent noise due to integer overflow.

(Insert W. examples)

##### Transfering binary payloads, a better way to travel

Google's _Protocol Buffers_ convert language-specific data structures to a universal binary transfer format. It has interfaces in several languages, but not `R`. Fortunately `RProtoBuf` wraps _Protocol Buffers_, and goes a step further, to generate protocol payload conversion descriptions (as contained in `.proto` files) dynamically, hiding the machinery needed with other languages. 

```{r}
if (!("RProtoBuf"  %in% .packages(all=TRUE)) ) {
    install.packages("RProtoBuf")
}
library(RProtoBuf)
```

On the Mac you may instead get an error during install:

```
   checking google/protobuf/stubs/common.h usability... no
   checking google/protobuf/stubs/common.h presence... no
   checking for google/protobuf/stubs/common.h... no
   configure: WARNING: Protobuf headers not found with default CXXFLAGS and CPPFLAGS, manually trying /usr/local/include
```
This fails when `pkg-config` doesn't find include files that are missing. This is because the `RProtobuf` install requires your machine already to have Google's _Protocol Buffers_ installed from which it gets these files. To find out if they are there already, see if the compiler `protoc` runs at the command line. If it works you should get something like this: 
```{bash}
protoc --version
```
If instead the command isn't recognized, you need to install the `c++` version of [_Protocol Buffers_](https://developers.google.com/protocol-buffers/) from [its github repository](https://github.com/google/protobuf.git). Be forewarned that you may discover that this takes more than just a few steps since it requires an extensive toolchain. Follow 
the `README.md` file in the `src` directory, which has you run the `./autogen.sh` file in the root directory, then run `./configure`.

Note: On the Mac you will need several binaries that come installed with the _command line tools_, which come with Apple's _XCode_ development environment. Moreover, the 
configure command requires `bazel`, which you can install with `brew`, the Mac package install tool, which you can get from 

>   /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

Of course for this you need `ruby` installed. Then you can 

>   brew install bazel

and any other missing build tools, including glibtool (a replacement for Mac's native libtool).  Don't worry eventually you'll get 
everything needed.
 Does this remind you of the story _[If you give a Mouse a Cookie?](https://en.wikipedia.org/wiki/If_You_Give_a_Mouse_a_Cookie)_ You get the picture. :)
 
